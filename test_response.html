<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLCview - ë˜ë” ë‹¤ì´ì–´ê·¸ë¨ ë¯¸ëŸ¬ë§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .ladder-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .ladder-rung {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            background: #fafafa;
            border-radius: 5px;
            position: relative;
        }

        .rung-number {
            position: absolute;
            left: -30px;
            top: 15px;
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 12px;
        }

        .ladder-elements {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .contact {
            border: 2px solid #333;
            padding: 8px 12px;
            background: white;
            border-radius: 3px;
            font-family: monospace;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
            position: relative;
        }

        .contact.active {
            background: #4CAF50;
            color: white;
            border-color: #45a049;
        }

        .contact.nc {
            border-style: dashed;
        }

        .coil {
            border: 2px solid #333;
            padding: 8px 12px;
            background: #FFE082;
            border-radius: 50px;
            font-family: monospace;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }

        .coil.active {
            background: #FF9800;
            color: white;
        }

        .function-block {
            border: 2px solid #333;
            padding: 12px 15px;
            background: #E1F5FE;
            border-radius: 5px;
            font-family: monospace;
            font-weight: bold;
            text-align: center;
        }

        .function-block.active {
            background: #2196F3;
            color: white;
        }

        .connection-line {
            height: 2px;
            background: #333;
            flex-grow: 1;
            min-width: 20px;
        }

        .device-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .status-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-card h4 {
            color: #333;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .device-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 3px;
        }

        .device-value {
            font-weight: bold;
            color: #667eea;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-on { background-color: #4CAF50; }
        .status-off { background-color: #999; }
        .status-alarm { background-color: #f44336; }

        .controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ­ PLCview - MELSOFT ë˜ë” ë‹¤ì´ì–´ê·¸ë¨ ë¯¸ëŸ¬ë§</h1>
        <p>GX Works2 â†” ì›¹ ì¸í„°í˜ì´ìŠ¤ ì‹¤ì‹œê°„ ì—°ë™</p>
        <p>PLC Host: <span id="plcHost">192.168.3.39:1025</span></p>
    </div>

    <div class="controls">
        <h3>ğŸ”§ ì œì–´ íŒ¨ë„</h3>
        <button class="btn btn-success" onclick="connectPLC()">PLC ì—°ê²°</button>
        <button class="btn btn-danger" onclick="disconnectPLC()">ì—°ê²° í•´ì œ</button>
        <button class="btn btn-primary" onclick="startMonitoring()">ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
        <button class="btn btn-warning" onclick="stopMonitoring()">ëª¨ë‹ˆí„°ë§ ì¤‘ì§€</button>
        <button class="btn btn-primary" onclick="refreshData()">ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn btn-primary" onclick="downloadLog()">ë¡œê·¸ ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <!-- ë˜ë” ë‹¤ì´ì–´ê·¸ë¨ ë¯¸ëŸ¬ë§ -->
    <div class="ladder-container">
        <h3>ğŸ“Š ë˜ë” ë‹¤ì´ì–´ê·¸ë¨ ì‹¤ì‹œê°„ ìƒíƒœ</h3>

        <!-- Rung 0: ë©”ì¸ ì œì–´ ë¡œì§ -->
        <div class="ladder-rung">
            <div class="rung-number">0</div>
            <div class="ladder-elements">
                <div class="contact" id="contact_d2">â‰¥</div>
                <div class="device-value" id="value_d2">D2</div>
                <div class="device-value">K3000</div>
                <div class="connection-line"></div>
                <div class="contact" id="contact_d2_2">â‰¥</div>
                <div class="device-value">D2</div>
                <div class="device-value">K3000</div>
                <div class="connection-line"></div>
                <div class="function-block" id="mov_k300">MOV K300 D2</div>
            </div>
        </div>

        <!-- Rung 29: ë¹„êµ ë¡œì§ -->
        <div class="ladder-rung">
            <div class="rung-number">29</div>
            <div class="ladder-elements">
                <div class="contact" id="contact_d0">&lt;</div>
                <div class="device-value" id="value_d0">D0</div>
                <div class="device-value">K500</div>
                <div class="connection-line"></div>
                <div class="coil" id="coil_m30">M30</div>
            </div>
        </div>

        <!-- Rung 36: ìƒíƒœ ì œì–´ -->
        <div class="ladder-rung">
            <div class="rung-number">36</div>
            <div class="ladder-elements">
                <div class="contact" id="contact_sm400">SM400</div>
                <div class="connection-line"></div>
                <div class="contact" id="contact_d0_36">/</div>
                <div class="device-value">D0</div>
                <div class="device-value">K10</div>
                <div class="device-value">D10</div>
                <div class="connection-line"></div>
                <div class="contact" id="contact_plus">+</div>
                <div class="device-value">D10</div>
                <div class="device-value">K10</div>
                <div class="device-value">D11</div>
            </div>
        </div>

        <!-- Rung 43: ì„¼ì„œ ì²˜ë¦¬ -->
        <div class="ladder-rung">
            <div class="rung-number">43</div>
            <div class="ladder-elements">
                <div class="contact" id="contact_x204">X204</div>
                <div class="contact" id="contact_sm410">SM410</div>
                <div class="connection-line"></div>
                <div class="contact" id="contact_d6">&lt;</div>
                <div class="device-value" id="value_d6">D6</div>
                <div class="device-value">K30</div>
                <div class="contact" id="contact_y45">Y45</div>
                <div class="connection-line"></div>
                <div class="function-block" id="dhp_function">D+P D4 D2 D4</div>
                <div class="connection-line"></div>
                <div class="function-block" id="incp_function">INCP D6</div>
            </div>
        </div>

        <!-- Rung 68: ëª¨í„° ì œì–´ -->
        <div class="ladder-rung">
            <div class="rung-number">68</div>
            <div class="ladder-elements">
                <div class="contact" id="contact_x0">X0</div>
                <div class="contact" id="contact_m0">M0</div>
                <div class="connection-line"></div>
                <div class="function-block" id="mov_k0">MOV K0 D4</div>
            </div>
        </div>
    </div>

    <!-- ì‹¤ì‹œê°„ ë””ë°”ì´ìŠ¤ ìƒíƒœ -->
    <div class="device-status">
        <div class="status-card">
            <h4>ğŸ”Œ ì…ë ¥ ë””ë°”ì´ìŠ¤ (X)</h4>
            <div class="device-item">
                <span><span class="status-indicator status-off" id="status_x0"></span>X0</span>
                <span class="device-value" id="x0_value">OFF</span>
            </div>
            <div class="device-item">
                <span><span class="status-indicator status-off" id="status_x204"></span>X204</span>
                <span class="device-value" id="x204_value">OFF</span>
            </div>
        </div>

        <div class="status-card">
            <h4>ğŸ”— ì¶œë ¥ ë””ë°”ì´ìŠ¤ (Y, M)</h4>
            <div class="device-item">
                <span><span class="status-indicator status-off" id="status_y45"></span>Y45</span>
                <span class="device-value" id="y45_value">OFF</span>
            </div>
            <div class="device-item">
                <span><span class="status-indicator status-off" id="status_m0"></span>M0</span>
                <span class="device-value" id="m0_value">OFF</span>
            </div>
            <div class="device-item">
                <span><span class="status-indicator status-off" id="status_m30"></span>M30</span>
                <span class="device-value" id="m30_value">OFF</span>
            </div>
        </div>

        <div class="status-card">
            <h4>ğŸ“Š ë°ì´í„° ë ˆì§€ìŠ¤í„° (D)</h4>
            <div class="device-item">
                <span>D0 (ì˜¨ë„)</span>
                <span class="device-value" id="d0_value">0Â°C</span>
            </div>
            <div class="device-item">
                <span>D2 (ì••ë ¥)</span>
                <span class="device-value" id="d2_value">0 kPa</span>
            </div>
            <div class="device-item">
                <span>D4 (ì†ë„)</span>
                <span class="device-value" id="d4_value">0 RPM</span>
            </div>
            <div class="device-item">
                <span>D6 (ì¹´ìš´í„°)</span>
                <span class="device-value" id="d6_value">0</span>
            </div>
        </div>

        <div class="status-card">
            <h4>âš™ï¸ ì‹œìŠ¤í…œ ë””ë°”ì´ìŠ¤ (SM)</h4>
            <div class="device-item">
                <span><span class="status-indicator status-off" id="status_sm400"></span>SM400</span>
                <span class="device-value" id="sm400_value">OFF</span>
            </div>
            <div class="device-item">
                <span><span class="status-indicator status-off" id="status_sm410"></span>SM410</span>
                <span class="device-value" id="sm410_value">OFF</span>
            </div>
        </div>
    </div>

    <script>
        let monitoringInterval = null;
        let wsConnection = null;

        // PLC ì—°ê²°
        async function connectPLC() {
            try {
                const response = await fetch('/api/v1/plc/connect', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    alert('âœ… PLC ì—°ê²° ì„±ê³µ');
                    updateConnectionStatus(true);
                } else {
                    alert('âŒ PLC ì—°ê²° ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                alert('âŒ ì—°ê²° ì˜¤ë¥˜: ' + error.message);
            }
        }

        // PLC ì—°ê²° í•´ì œ
        async function disconnectPLC() {
            try {
                const response = await fetch('/api/v1/plc/disconnect', { method: 'POST' });
                const result = await response.json();
                alert('ğŸ”Œ PLC ì—°ê²° í•´ì œë¨');
                updateConnectionStatus(false);
                stopMonitoring();
            } catch (error) {
                alert('âŒ ì—°ê²° í•´ì œ ì˜¤ë¥˜: ' + error.message);
            }
        }

        // ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘
        function startMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }

            // WebSocket ì—°ê²°
            try {
                wsConnection = new WebSocket('ws://localhost:8000/ws/plc-data');

                wsConnection.onopen = function() {
                    console.log('WebSocket ì—°ê²°ë¨');
                };

                wsConnection.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    updateLadderDiagram(data);
                };

                wsConnection.onclose = function() {
                    console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
                };
            } catch (error) {
                console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
            }

            // HTTP í´ë§ ë°±ì—…
            monitoringInterval = setInterval(refreshData, 1000);
            alert('ğŸ“Š ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘');
        }

        // ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            if (wsConnection) {
                wsConnection.close();
                wsConnection = null;
            }
            alert('â¹ï¸ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€');
        }

        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        async function refreshData() {
            try {
                // ì—¬ëŸ¬ ë””ë°”ì´ìŠ¤ ë°ì´í„°ë¥¼ ë³‘ë ¬ë¡œ ì½ê¸°
                const devices = ['D0', 'D2', 'D4', 'D6', 'X0', 'X204', 'Y45', 'M0', 'M30', 'SM400', 'SM410'];

                for (const device of devices) {
                    try {
                        const response = await fetch(`/api/v1/plc/device/${device}`);
                        const result = await response.json();
                        updateDeviceValue(device, result.value);
                    } catch (error) {
                        console.error(`${device} ì½ê¸° ì‹¤íŒ¨:`, error);
                    }
                }
            } catch (error) {
                console.error('ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
            }
        }

        // ë˜ë” ë‹¤ì´ì–´ê·¸ë¨ ì—…ë°ì´íŠ¸
        function updateLadderDiagram(data) {
            if (data.plc_data) {
                // ë°ì´í„° ë ˆì§€ìŠ¤í„° ì—…ë°ì´íŠ¸
                updateDeviceValue('D0', data.plc_data.temperature || 0);
                updateDeviceValue('D2', data.plc_data.pressure || 0);
                updateDeviceValue('D4', data.plc_data.speed || 0);

                // ì‹œë®¬ë ˆì´í„° ë°ì´í„°ì—ì„œ ì¶”ê°€ ì •ë³´ ì¶”ì¶œ
                updateDeviceValue('D6', Math.floor(Math.random() * 100));
                updateDeviceValue('X0', Math.random() > 0.7);
                updateDeviceValue('X204', Math.random() > 0.8);
                updateDeviceValue('Y45', data.plc_data.temperature > 50);
                updateDeviceValue('M0', data.plc_data.pressure > 500);
                updateDeviceValue('M30', data.plc_data.speed > 1000);
                updateDeviceValue('SM400', data.status === 'connected');
                updateDeviceValue('SM410', data.status === 'error');
            }
        }

        // ê°œë³„ ë””ë°”ì´ìŠ¤ ê°’ ì—…ë°ì´íŠ¸
        function updateDeviceValue(device, value) {
            const deviceLower = device.toLowerCase();
            const valueElement = document.getElementById(`${deviceLower}_value`);
            const statusElement = document.getElementById(`status_${deviceLower}`);
            const contactElement = document.getElementById(`contact_${deviceLower}`);

            if (device.startsWith('D')) {
                // ë°ì´í„° ë ˆì§€ìŠ¤í„°
                let unit = '';
                if (device === 'D0') unit = 'Â°C';
                else if (device === 'D2') unit = ' kPa';
                else if (device === 'D4') unit = ' RPM';

                if (valueElement) {
                    valueElement.textContent = value + unit;
                }
                if (document.getElementById(`value_${deviceLower}`)) {
                    document.getElementById(`value_${deviceLower}`).textContent = device;
                }
            } else {
                // ë¹„íŠ¸ ë””ë°”ì´ìŠ¤ (X, Y, M, SM)
                const isOn = Boolean(value);

                if (valueElement) {
                    valueElement.textContent = isOn ? 'ON' : 'OFF';
                }

                if (statusElement) {
                    statusElement.className = `status-indicator ${isOn ? 'status-on' : 'status-off'}`;
                }

                if (contactElement) {
                    if (isOn) {
                        contactElement.classList.add('active');
                    } else {
                        contactElement.classList.remove('active');
                    }
                }
            }

            // í•¨ìˆ˜ ë¸”ë¡ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
            updateFunctionBlocks();
        }

        // í•¨ìˆ˜ ë¸”ë¡ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateFunctionBlocks() {
            // MOV K300 D2 í™œì„±í™” ì¡°ê±´
            const d2Value = parseInt(document.getElementById('d2_value')?.textContent) || 0;
            const movK300 = document.getElementById('mov_k300');
            if (movK300 && d2Value >= 3000) {
                movK300.classList.add('active');
            } else if (movK300) {
                movK300.classList.remove('active');
            }

            // M30 ì½”ì¼ í™œì„±í™” ì¡°ê±´
            const d0Value = parseInt(document.getElementById('d0_value')?.textContent) || 0;
            const coilM30 = document.getElementById('coil_m30');
            if (coilM30 && d0Value < 500) {
                coilM30.classList.add('active');
            } else if (coilM30) {
                coilM30.classList.remove('active');
            }
        }

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(connected) {
            document.getElementById('plcHost').style.color = connected ? '#4CAF50' : '#f44336';
        }

        // ë¡œê·¸ ë‹¤ìš´ë¡œë“œ
        function downloadLog() {
            const timestamp = new Date().toISOString();
            const logData = {
                timestamp: timestamp,
                devices: {},
                ladder_status: {}
            };

            // í˜„ì¬ ë””ë°”ì´ìŠ¤ ê°’ë“¤ ìˆ˜ì§‘
            const devices = ['D0', 'D2', 'D4', 'D6', 'X0', 'X204', 'Y45', 'M0', 'M30', 'SM400', 'SM410'];
            devices.forEach(device => {
                const element = document.getElementById(`${device.toLowerCase()}_value`);
                if (element) {
                    logData.devices[device] = element.textContent;
                }
            });

            const blob = new Blob([JSON.stringify(logData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `plc_log_${timestamp.replace(/[:.]/g, '-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ë˜ë” ë‹¤ì´ì–´ê·¸ë¨ ë¯¸ëŸ¬ë§ ì´ˆê¸°í™”');
            refreshData();
        });
    </script>
</body>
</html>