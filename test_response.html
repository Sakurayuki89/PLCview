<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLCview - 래더 다이어그램 미러링</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .ladder-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .ladder-rung {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            background: #fafafa;
            border-radius: 5px;
            position: relative;
        }

        .rung-number {
            position: absolute;
            left: -30px;
            top: 15px;
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 12px;
        }

        .ladder-elements {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .contact {
            border: 2px solid #333;
            padding: 8px 12px;
            background: white;
            border-radius: 3px;
            font-family: monospace;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
            position: relative;
        }

        .contact.active {
            background: #4CAF50;
            color: white;
            border-color: #45a049;
        }

        .contact.nc {
            border-style: dashed;
        }

        .coil {
            border: 2px solid #333;
            padding: 8px 12px;
            background: #FFE082;
            border-radius: 50px;
            font-family: monospace;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }

        .coil.active {
            background: #FF9800;
            color: white;
        }

        .function-block {
            border: 2px solid #333;
            padding: 12px 15px;
            background: #E1F5FE;
            border-radius: 5px;
            font-family: monospace;
            font-weight: bold;
            text-align: center;
        }

        .function-block.active {
            background: #2196F3;
            color: white;
        }

        .connection-line {
            height: 2px;
            background: #333;
            flex-grow: 1;
            min-width: 20px;
        }

        .device-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .status-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-card h4 {
            color: #333;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .device-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 3px;
        }

        .device-value {
            font-weight: bold;
            color: #667eea;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-on { background-color: #4CAF50; }
        .status-off { background-color: #999; }
        .status-alarm { background-color: #f44336; }

        .controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🏭 PLCview - MELSOFT 래더 다이어그램 미러링</h1>
        <p>GX Works2 ↔ 웹 인터페이스 실시간 연동</p>
        <p>PLC Host: <span id="plcHost">192.168.3.39:1025</span></p>
    </div>

    <div class="controls">
        <h3>🔧 제어 패널</h3>
        <button class="btn btn-success" onclick="connectPLC()">PLC 연결</button>
        <button class="btn btn-danger" onclick="disconnectPLC()">연결 해제</button>
        <button class="btn btn-primary" onclick="startMonitoring()">실시간 모니터링 시작</button>
        <button class="btn btn-warning" onclick="stopMonitoring()">모니터링 중지</button>
        <button class="btn btn-primary" onclick="refreshData()">데이터 새로고침</button>
        <button class="btn btn-primary" onclick="downloadLog()">로그 다운로드</button>
    </div>

    <!-- 래더 다이어그램 미러링 -->
    <div class="ladder-container">
        <h3>📊 래더 다이어그램 실시간 상태</h3>

        <!-- Rung 0: 메인 제어 로직 -->
        <div class="ladder-rung">
            <div class="rung-number">0</div>
            <div class="ladder-elements">
                <div class="contact" id="contact_d2">≥</div>
                <div class="device-value" id="value_d2">D2</div>
                <div class="device-value">K3000</div>
                <div class="connection-line"></div>
                <div class="contact" id="contact_d2_2">≥</div>
                <div class="device-value">D2</div>
                <div class="device-value">K3000</div>
                <div class="connection-line"></div>
                <div class="function-block" id="mov_k300">MOV K300 D2</div>
            </div>
        </div>

        <!-- Rung 29: 비교 로직 -->
        <div class="ladder-rung">
            <div class="rung-number">29</div>
            <div class="ladder-elements">
                <div class="contact" id="contact_d0">&lt;</div>
                <div class="device-value" id="value_d0">D0</div>
                <div class="device-value">K500</div>
                <div class="connection-line"></div>
                <div class="coil" id="coil_m30">M30</div>
            </div>
        </div>

        <!-- Rung 36: 상태 제어 -->
        <div class="ladder-rung">
            <div class="rung-number">36</div>
            <div class="ladder-elements">
                <div class="contact" id="contact_sm400">SM400</div>
                <div class="connection-line"></div>
                <div class="contact" id="contact_d0_36">/</div>
                <div class="device-value">D0</div>
                <div class="device-value">K10</div>
                <div class="device-value">D10</div>
                <div class="connection-line"></div>
                <div class="contact" id="contact_plus">+</div>
                <div class="device-value">D10</div>
                <div class="device-value">K10</div>
                <div class="device-value">D11</div>
            </div>
        </div>

        <!-- Rung 43: 센서 처리 -->
        <div class="ladder-rung">
            <div class="rung-number">43</div>
            <div class="ladder-elements">
                <div class="contact" id="contact_x204">X204</div>
                <div class="contact" id="contact_sm410">SM410</div>
                <div class="connection-line"></div>
                <div class="contact" id="contact_d6">&lt;</div>
                <div class="device-value" id="value_d6">D6</div>
                <div class="device-value">K30</div>
                <div class="contact" id="contact_y45">Y45</div>
                <div class="connection-line"></div>
                <div class="function-block" id="dhp_function">D+P D4 D2 D4</div>
                <div class="connection-line"></div>
                <div class="function-block" id="incp_function">INCP D6</div>
            </div>
        </div>

        <!-- Rung 68: 모터 제어 -->
        <div class="ladder-rung">
            <div class="rung-number">68</div>
            <div class="ladder-elements">
                <div class="contact" id="contact_x0">X0</div>
                <div class="contact" id="contact_m0">M0</div>
                <div class="connection-line"></div>
                <div class="function-block" id="mov_k0">MOV K0 D4</div>
            </div>
        </div>
    </div>

    <!-- 실시간 디바이스 상태 -->
    <div class="device-status">
        <div class="status-card">
            <h4>🔌 입력 디바이스 (X)</h4>
            <div class="device-item">
                <span><span class="status-indicator status-off" id="status_x0"></span>X0</span>
                <span class="device-value" id="x0_value">OFF</span>
            </div>
            <div class="device-item">
                <span><span class="status-indicator status-off" id="status_x204"></span>X204</span>
                <span class="device-value" id="x204_value">OFF</span>
            </div>
        </div>

        <div class="status-card">
            <h4>🔗 출력 디바이스 (Y, M)</h4>
            <div class="device-item">
                <span><span class="status-indicator status-off" id="status_y45"></span>Y45</span>
                <span class="device-value" id="y45_value">OFF</span>
            </div>
            <div class="device-item">
                <span><span class="status-indicator status-off" id="status_m0"></span>M0</span>
                <span class="device-value" id="m0_value">OFF</span>
            </div>
            <div class="device-item">
                <span><span class="status-indicator status-off" id="status_m30"></span>M30</span>
                <span class="device-value" id="m30_value">OFF</span>
            </div>
        </div>

        <div class="status-card">
            <h4>📊 데이터 레지스터 (D)</h4>
            <div class="device-item">
                <span>D0 (온도)</span>
                <span class="device-value" id="d0_value">0°C</span>
            </div>
            <div class="device-item">
                <span>D2 (압력)</span>
                <span class="device-value" id="d2_value">0 kPa</span>
            </div>
            <div class="device-item">
                <span>D4 (속도)</span>
                <span class="device-value" id="d4_value">0 RPM</span>
            </div>
            <div class="device-item">
                <span>D6 (카운터)</span>
                <span class="device-value" id="d6_value">0</span>
            </div>
        </div>

        <div class="status-card">
            <h4>⚙️ 시스템 디바이스 (SM)</h4>
            <div class="device-item">
                <span><span class="status-indicator status-off" id="status_sm400"></span>SM400</span>
                <span class="device-value" id="sm400_value">OFF</span>
            </div>
            <div class="device-item">
                <span><span class="status-indicator status-off" id="status_sm410"></span>SM410</span>
                <span class="device-value" id="sm410_value">OFF</span>
            </div>
        </div>
    </div>

    <script>
        let monitoringInterval = null;
        let wsConnection = null;

        // PLC 연결
        async function connectPLC() {
            try {
                const response = await fetch('/api/v1/plc/connect', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    alert('✅ PLC 연결 성공');
                    updateConnectionStatus(true);
                } else {
                    alert('❌ PLC 연결 실패: ' + result.message);
                }
            } catch (error) {
                alert('❌ 연결 오류: ' + error.message);
            }
        }

        // PLC 연결 해제
        async function disconnectPLC() {
            try {
                const response = await fetch('/api/v1/plc/disconnect', { method: 'POST' });
                const result = await response.json();
                alert('🔌 PLC 연결 해제됨');
                updateConnectionStatus(false);
                stopMonitoring();
            } catch (error) {
                alert('❌ 연결 해제 오류: ' + error.message);
            }
        }

        // 실시간 모니터링 시작
        function startMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }

            // WebSocket 연결
            try {
                wsConnection = new WebSocket('ws://localhost:8000/ws/plc-data');

                wsConnection.onopen = function() {
                    console.log('WebSocket 연결됨');
                };

                wsConnection.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    updateLadderDiagram(data);
                };

                wsConnection.onclose = function() {
                    console.log('WebSocket 연결 종료');
                };
            } catch (error) {
                console.error('WebSocket 연결 실패:', error);
            }

            // HTTP 폴링 백업
            monitoringInterval = setInterval(refreshData, 1000);
            alert('📊 실시간 모니터링 시작');
        }

        // 실시간 모니터링 중지
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            if (wsConnection) {
                wsConnection.close();
                wsConnection = null;
            }
            alert('⏹️ 실시간 모니터링 중지');
        }

        // 데이터 새로고침
        async function refreshData() {
            try {
                // 여러 디바이스 데이터를 병렬로 읽기
                const devices = ['D0', 'D2', 'D4', 'D6', 'X0', 'X204', 'Y45', 'M0', 'M30', 'SM400', 'SM410'];

                for (const device of devices) {
                    try {
                        const response = await fetch(`/api/v1/plc/device/${device}`);
                        const result = await response.json();
                        updateDeviceValue(device, result.value);
                    } catch (error) {
                        console.error(`${device} 읽기 실패:`, error);
                    }
                }
            } catch (error) {
                console.error('데이터 새로고침 실패:', error);
            }
        }

        // 래더 다이어그램 업데이트
        function updateLadderDiagram(data) {
            if (data.plc_data) {
                // 데이터 레지스터 업데이트
                updateDeviceValue('D0', data.plc_data.temperature || 0);
                updateDeviceValue('D2', data.plc_data.pressure || 0);
                updateDeviceValue('D4', data.plc_data.speed || 0);

                // 시뮬레이터 데이터에서 추가 정보 추출
                updateDeviceValue('D6', Math.floor(Math.random() * 100));
                updateDeviceValue('X0', Math.random() > 0.7);
                updateDeviceValue('X204', Math.random() > 0.8);
                updateDeviceValue('Y45', data.plc_data.temperature > 50);
                updateDeviceValue('M0', data.plc_data.pressure > 500);
                updateDeviceValue('M30', data.plc_data.speed > 1000);
                updateDeviceValue('SM400', data.status === 'connected');
                updateDeviceValue('SM410', data.status === 'error');
            }
        }

        // 개별 디바이스 값 업데이트
        function updateDeviceValue(device, value) {
            const deviceLower = device.toLowerCase();
            const valueElement = document.getElementById(`${deviceLower}_value`);
            const statusElement = document.getElementById(`status_${deviceLower}`);
            const contactElement = document.getElementById(`contact_${deviceLower}`);

            if (device.startsWith('D')) {
                // 데이터 레지스터
                let unit = '';
                if (device === 'D0') unit = '°C';
                else if (device === 'D2') unit = ' kPa';
                else if (device === 'D4') unit = ' RPM';

                if (valueElement) {
                    valueElement.textContent = value + unit;
                }
                if (document.getElementById(`value_${deviceLower}`)) {
                    document.getElementById(`value_${deviceLower}`).textContent = device;
                }
            } else {
                // 비트 디바이스 (X, Y, M, SM)
                const isOn = Boolean(value);

                if (valueElement) {
                    valueElement.textContent = isOn ? 'ON' : 'OFF';
                }

                if (statusElement) {
                    statusElement.className = `status-indicator ${isOn ? 'status-on' : 'status-off'}`;
                }

                if (contactElement) {
                    if (isOn) {
                        contactElement.classList.add('active');
                    } else {
                        contactElement.classList.remove('active');
                    }
                }
            }

            // 함수 블록 활성화 상태 업데이트
            updateFunctionBlocks();
        }

        // 함수 블록 활성화 상태 업데이트
        function updateFunctionBlocks() {
            // MOV K300 D2 활성화 조건
            const d2Value = parseInt(document.getElementById('d2_value')?.textContent) || 0;
            const movK300 = document.getElementById('mov_k300');
            if (movK300 && d2Value >= 3000) {
                movK300.classList.add('active');
            } else if (movK300) {
                movK300.classList.remove('active');
            }

            // M30 코일 활성화 조건
            const d0Value = parseInt(document.getElementById('d0_value')?.textContent) || 0;
            const coilM30 = document.getElementById('coil_m30');
            if (coilM30 && d0Value < 500) {
                coilM30.classList.add('active');
            } else if (coilM30) {
                coilM30.classList.remove('active');
            }
        }

        // 연결 상태 업데이트
        function updateConnectionStatus(connected) {
            document.getElementById('plcHost').style.color = connected ? '#4CAF50' : '#f44336';
        }

        // 로그 다운로드
        function downloadLog() {
            const timestamp = new Date().toISOString();
            const logData = {
                timestamp: timestamp,
                devices: {},
                ladder_status: {}
            };

            // 현재 디바이스 값들 수집
            const devices = ['D0', 'D2', 'D4', 'D6', 'X0', 'X204', 'Y45', 'M0', 'M30', 'SM400', 'SM410'];
            devices.forEach(device => {
                const element = document.getElementById(`${device.toLowerCase()}_value`);
                if (element) {
                    logData.devices[device] = element.textContent;
                }
            });

            const blob = new Blob([JSON.stringify(logData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `plc_log_${timestamp.replace(/[:.]/g, '-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('래더 다이어그램 미러링 초기화');
            refreshData();
        });
    </script>
</body>
</html>