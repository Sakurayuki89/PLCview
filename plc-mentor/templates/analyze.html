{% extends "base.html" %}

{% block title %}GXW íŒŒì¼ ë¶„ì„ - PLC Mentor{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-primary text-white">
            <div class="card-body text-center py-4">
                <h1 class="display-5 mb-2">
                    <i class="fas fa-search me-3"></i>
                    GXW íŒŒì¼ ë¶„ì„
                </h1>
                <p class="lead mb-0">
                    GX Works2 í”„ë¡œì íŠ¸ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ìë™ìœ¼ë¡œ ë¶„ì„í•˜ê³  ì´í•´í•˜ê¸° ì‰¬ìš´ ì„¤ëª…ì„ ë°›ì•„ë³´ì„¸ìš”
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Upload Section -->
<div class="row mb-4">
    <div class="col-lg-8 offset-lg-2">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">
                    <i class="fas fa-upload text-primary me-2"></i>
                    íŒŒì¼ ì—…ë¡œë“œ
                </h3>
            </div>
            <div class="card-body">
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file-input" class="form-label">
                            <i class="fas fa-file me-1"></i>
                            GXW íŒŒì¼ ì„ íƒ
                        </label>
                        <input type="file"
                               class="form-control"
                               id="file-input"
                               name="file"
                               accept=".gxw,.gx2,.gx3"
                               onchange="handleFileSelection(this)"
                               required>
                        <div class="form-text">
                            ì§€ì› íŒŒì¼: .gxw, .gx2, .gx3 (ìµœëŒ€ 16MB)
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-play me-2"></i>
                            ë¶„ì„ ì‹œì‘
                        </button>
                    </div>
                </form>

                <!-- Progress Bar -->
                <div id="progress-container" class="progress-container" style="display: none;">
                    <h5 class="text-center mb-3">
                        <i class="fas fa-cog fa-spin me-2"></i>
                        íŒŒì¼ ë¶„ì„ ì¤‘...
                    </h5>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             style="width: 100%"></div>
                    </div>
                    <p class="text-center mt-2 text-muted">
                        íŒŒì¼ì„ ì½ê³  ë¶„ì„í•˜ì—¬ ì´í•´í•˜ê¸° ì‰¬ìš´ ì„¤ëª…ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Container -->
<div id="results-container" style="display: none;">
    <!-- Project Overview -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h3 class="mb-0">
                        <i class="fas fa-info-circle text-primary me-2"></i>
                        í”„ë¡œì íŠ¸ ê°œìš”
                    </h3>
                </div>
                <div class="card-body">
                    <div id="project-overview">
                        <!-- í”„ë¡œì íŠ¸ ê°œìš”ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Device Analysis -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h3 class="mb-0">
                        <i class="fas fa-microchip text-success me-2"></i>
                        ë””ë°”ì´ìŠ¤ ë¶„ì„
                    </h3>
                </div>
                <div class="card-body">
                    <div id="device-analysis">
                        <!-- ë””ë°”ì´ìŠ¤ ë¶„ì„ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ladder Logic Explanation -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h3 class="mb-0">
                        <i class="fas fa-layer-group text-warning me-2"></i>
                        ë˜ë” ë¡œì§ ì„¤ëª…
                    </h3>
                </div>
                <div class="card-body">
                    <div id="ladder-explanation">
                        <!-- ë˜ë” ë¡œì§ ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CODESYS Conversion -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h3 class="mb-0">
                        <i class="fas fa-exchange-alt text-info me-2"></i>
                        CODESYS ë³€í™˜ ê²°ê³¼
                    </h3>
                </div>
                <div class="card-body">
                    <div id="codesys-conversion">
                        <!-- CODESYS ë³€í™˜ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h4 class="mb-3">
                        <i class="fas fa-rocket text-primary me-2"></i>
                        ë‹¤ìŒ ë‹¨ê³„
                    </h4>
                    <div class="d-flex justify-content-center flex-wrap gap-3">
                        <a href="/learn" class="btn btn-primary btn-lg">
                            <i class="fas fa-graduation-cap me-2"></i>
                            ë” ìì„¸í•˜ê²Œ í•™ìŠµí•˜ê¸°
                        </a>
                        <a href="/convert" class="btn btn-info btn-lg">
                            <i class="fas fa-exchange-alt me-2"></i>
                            ë‹¤ë¥¸ íŒŒì¼ ë³€í™˜í•˜ê¸°
                        </a>
                        <button class="btn btn-success btn-lg" onclick="downloadResults()">
                            <i class="fas fa-download me-2"></i>
                            ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let analysisResults = null;

// íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬
function handleFileSelection(input) {
    // íŒŒì¼ í¬ê¸° ê²€ì¦
    if (!validateFileSize(input)) {
        return;
    }

    const file = input.files[0];
    if (file) {
        // ì„ íƒëœ íŒŒì¼ í‘œì‹œ
        showSelectedFile(file.name);
    }
}

// ì„ íƒëœ íŒŒì¼ í‘œì‹œ
function showSelectedFile(fileName) {
    const fileInput = document.getElementById('file-input');
    const parentDiv = fileInput.parentElement;

    // ê¸°ì¡´ ì„ íƒ ì•Œë¦¼ ì œê±°
    const existingAlert = parentDiv.querySelector('.selected-file-alert');
    if (existingAlert) {
        existingAlert.remove();
    }

    // ì—…ë¡œë“œ ì™„ë£Œ ì•Œë¦¼ ì œê±° (ìƒˆ íŒŒì¼ ì„ íƒ ì‹œ)
    const uploadedAlert = parentDiv.querySelector('.uploaded-file-alert');
    if (uploadedAlert) {
        uploadedAlert.remove();
    }

    // ìƒˆ ì„ íƒ ì•Œë¦¼ ìƒì„±
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-info selected-file-alert mt-2 d-flex justify-content-between align-items-center';
    alertDiv.innerHTML = '<div><i class="fas fa-file me-2"></i><strong>ì„ íƒëœ íŒŒì¼:</strong> ' + fileName + '</div><small class="text-muted">ë¶„ì„ ì‹œì‘ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</small>';

    // íŒŒì¼ input ë‹¤ìŒì— ì¶”ê°€
    fileInput.parentElement.appendChild(alertDiv);
}

// ì—…ë¡œë“œëœ íŒŒì¼ ì´ë¦„ í‘œì‹œ
function showUploadedFileName(fileName) {
    const fileInput = document.getElementById('file-input');
    const parentDiv = fileInput.parentElement;

    // ê¸°ì¡´ ì—…ë¡œë“œ ì•Œë¦¼ ì œê±°
    const existingAlert = parentDiv.querySelector('.uploaded-file-alert');
    if (existingAlert) {
        existingAlert.remove();
    }

    // ì„ íƒ ì•Œë¦¼ ì œê±°
    const selectedAlert = parentDiv.querySelector('.selected-file-alert');
    if (selectedAlert) {
        selectedAlert.remove();
    }

    // ìƒˆ ì•Œë¦¼ ìƒì„±
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success uploaded-file-alert mt-2 d-flex justify-content-between align-items-center';
    alertDiv.innerHTML = '<div><i class="fas fa-check-circle me-2"></i><strong>ì—…ë¡œë“œ ì™„ë£Œ:</strong> ' + fileName + '</div><button type="button" class="btn btn-sm btn-outline-success" onclick="resetFileInput()"><i class="fas fa-plus me-1"></i>ë‹¤ë¥¸ íŒŒì¼ ì„ íƒ</button>';

    // íŒŒì¼ input ë‹¤ìŒì— ì¶”ê°€
    fileInput.parentElement.appendChild(alertDiv);
}

// íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
function resetFileInput() {
    const fileInput = document.getElementById('file-input');
    fileInput.value = '';

    // ëª¨ë“  ì•Œë¦¼ ì œê±°
    const existingAlerts = document.querySelectorAll('.selected-file-alert, .uploaded-file-alert');
    existingAlerts.forEach(alert => alert.remove());

    // ê²°ê³¼ ì˜ì—­ ìˆ¨ê¸°ê¸°
    document.getElementById('results-container').style.display = 'none';

    // ì•Œë¦¼ í‘œì‹œ
    showAlert('ìƒˆ íŒŒì¼ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'info');
}

// íŒŒì¼ ì—…ë¡œë“œ ë° ë¶„ì„
document.getElementById('upload-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const fileInput = document.getElementById('file-input');
    const file = fileInput.files[0];

    if (!file) {
        showAlert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    // ì—…ë¡œë“œ ì‹œì‘
    showProgress();

    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            analysisResults = result;
            displayResults(result);
            showAlert('ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success');

            // ì—…ë¡œë“œëœ íŒŒì¼ ì´ë¦„ í‘œì‹œ
            showUploadedFileName(file.name);
        } else {
            showAlert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + result.error, 'danger');
        }
    } catch (error) {
        showAlert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
        console.error('Error:', error);
    } finally {
        document.getElementById('progress-container').style.display = 'none';
    }
});

// ë¶„ì„ ê²°ê³¼ í‘œì‹œ
function displayResults(results) {
    document.getElementById('results-container').style.display = 'block';

    displayProjectOverview(results);
    displayDeviceAnalysis(results);
    displayLadderExplanation(results);
    displayCodesysConversion(results);
}

// í”„ë¡œì íŠ¸ ê°œìš” í‘œì‹œ
function displayProjectOverview(results) {
    const projectInfo = results.project_data?.project_info || {};

    const html = '<div class="row"><div class="col-md-6"><h5><i class="fas fa-folder-open text-primary me-2"></i>í”„ë¡œì íŠ¸ ì •ë³´</h5><p><strong>íŒŒì¼ëª…:</strong> ' + (results.filename || 'Unknown') + '</p><p><strong>í”„ë¡œì íŠ¸ëª…:</strong> ' + (projectInfo.name || 'PLC í”„ë¡œì íŠ¸') + '</p></div><div class="col-md-6"><h5><i class="fas fa-chart-bar text-success me-2"></i>ë¶„ì„ ìš”ì•½</h5><p><strong>ì´ ë””ë°”ì´ìŠ¤:</strong> ' + (results.project_data?.devices?.length || 0) + 'ê°œ</p><p><strong>ë˜ë” ë‹¨ê³„:</strong> ' + (results.project_data?.ladder_rungs?.length || 0) + 'ê°œ</p></div></div>';

    document.getElementById('project-overview').innerHTML = html;
}

// ë””ë°”ì´ìŠ¤ ë¶„ì„ í‘œì‹œ
function displayDeviceAnalysis(results) {
    const devices = results.project_data?.devices || [];

    let html = '<div class="row mb-3"><div class="col-12"><h5><i class="fas fa-chart-pie text-success me-2"></i>ë””ë°”ì´ìŠ¤ í˜„í™© (ì´ ' + devices.length + 'ê°œ)</h5></div></div><div class="row g-3">';

    devices.forEach(device => {
        const deviceClass = {
            'INPUT': 'device-input',
            'OUTPUT': 'device-output',
            'MEMORY': 'device-memory',
            'TIMER': 'device-timer'
        }[device.type] || 'device-memory';

        html += '<div class="col-md-6 col-lg-4"><div class="card border-0 shadow-sm h-100"><div class="card-body"><div class="d-flex justify-content-between align-items-start mb-2"><span class="device-badge ' + deviceClass + '">' + device.name + '</span><small class="text-muted">ì‚¬ìš© ' + (device.used_count || 1) + 'íšŒ</small></div><h6 class="card-title">' + (device.description || device.name) + '</h6><p class="card-text small text-muted">' + getDeviceExplanation(device.type, device.name) + '</p>';

        if (device.safety_level === 'CRITICAL') {
            html += '<div class="alert alert-danger alert-sm py-1 px-2 small mb-0"><i class="fas fa-exclamation-triangle me-1"></i>ì•ˆì „ ì¤‘ìš” ë””ë°”ì´ìŠ¤</div>';
        }

        html += '</div></div></div>';
    });

    html += '</div>';

    document.getElementById('device-analysis').innerHTML = html;
}

// ë˜ë” ë¡œì§ ì„¤ëª… í‘œì‹œ
function displayLadderExplanation(results) {
    const ladderRungs = results.project_data?.ladder_rungs || [];

    let html = '<div class="row mb-3"><div class="col-12"><h5><i class="fas fa-list-ol text-warning me-2"></i>ë‹¨ê³„ë³„ ë™ì‘ ì„¤ëª… (ì´ ' + ladderRungs.length + 'ë‹¨ê³„)</h5></div></div>';

    ladderRungs.forEach((rung, index) => {
        html += '<div class="card mb-3"><div class="card-body"><div class="d-flex align-items-start"><div class="step-number">' + (index + 1) + '</div><div class="flex-grow-1"><h6 class="mb-2"><code>' + rung.instruction + ' ' + rung.device + '</code><span class="text-muted"> - ' + getInstructionKoreanName(rung.instruction) + '</span></h6><p class="mb-2">' + (rung.comment || 'ì„¤ëª… ì—†ìŒ') + '</p><div class="alert alert-light mb-0"><small><strong>ğŸ“š ìƒì„¸ ì„¤ëª…:</strong> ' + (rung.explanation || getInstructionExplanation(rung.instruction, rung.device)) + '</small></div></div></div></div></div>';
    });

    document.getElementById('ladder-explanation').innerHTML = html;
}

// CODESYS ë³€í™˜ ê²°ê³¼ í‘œì‹œ
function displayCodesysConversion(results) {
    const codesysCode = results.codesys_code || {};

    const html = '<div class="row"><div class="col-12"><h5 class="mb-3"><i class="fas fa-code text-info me-2"></i>CODESYS Structured Text (ST) ì½”ë“œ</h5><div class="card"><div class="card-header d-flex justify-content-between align-items-center"><span>ë³€í™˜ëœ ì½”ë“œ</span><button class="btn btn-sm btn-outline-primary" id="copy-codesys-btn"><i class="fas fa-copy me-1"></i>ë³µì‚¬</button></div><div class="card-body p-0"><div class="code-block">' + (codesysCode.structured_text || 'ë³€í™˜ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.') + '</div></div></div><div class="alert alert-info mt-3"><h6><i class="fas fa-lightbulb me-2"></i>ë³€í™˜ ì£¼ì˜ì‚¬í•­</h6><ul class="mb-0"><li>ğŸ“ êµìœ¡ì  ë³€í™˜: ì´í•´í•˜ê¸° ì‰¬ìš´ ì½”ë“œë¡œ ë³€í™˜í–ˆìŠµë‹ˆë‹¤</li><li>âš ï¸ ì•ˆì „: ì‹¤ì œ ìš´ìš© ì „ì— ì•ˆì „ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤</li><li>ğŸ”§ ìˆ˜ì •: CODESYS IDEì—ì„œ ì¶”ê°€ ìˆ˜ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li><li>ğŸ“ ë³€ìˆ˜ëª…: ì˜ë¯¸ìˆëŠ” ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”</li></ul></div></div></div>';

    document.getElementById('codesys-conversion').innerHTML = html;

    // ë³µì‚¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
    const copyBtn = document.getElementById('copy-codesys-btn');
    if (copyBtn) {
        copyBtn.addEventListener('click', function() {
            const codeText = codesysCode.structured_text || 'ë³€í™˜ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
            copyToClipboard(codeText);
        });
    }
}

// ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
function downloadResults() {
    if (!analysisResults) {
        showAlert('ë‹¤ìš´ë¡œë“œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
    }

    const data = {
        analysis_date: new Date().toISOString(),
        original_file: analysisResults.filename,
        project_data: analysisResults.project_data,
        codesys_code: analysisResults.codesys_code
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'plc_analysis_' + new Date().toISOString().slice(0, 10) + '.json';
    a.click();

    URL.revokeObjectURL(url);
    showAlert('ê²°ê³¼ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
}

// ë„ì›€ í•¨ìˆ˜ë“¤
function getDeviceExplanation(type, name) {
    const explanations = {
        'INPUT': name + 'ì€ ì™¸ë¶€ì—ì„œ ë“¤ì–´ì˜¤ëŠ” ì‹ í˜¸ì…ë‹ˆë‹¤. ì‹¤ì œ ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜ ì„¼ì„œê°€ ë™ì‘í•  ë•Œ ONë©ë‹ˆë‹¤.',
        'OUTPUT': name + 'ì€ PLCê°€ ì™¸ë¶€ ê¸°ê¸°ë¥¼ ì œì–´í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ëª¨í„°ë¥¼ ëŒë¦¬ê±°ë‚˜ LEDë¥¼ ì¼œëŠ” ì‹ìœ¼ë¡œìš”.',
        'MEMORY': name + 'ì€ PLC ë‚´ë¶€ì˜ ê°€ìƒ ìŠ¤ìœ„ì¹˜ì…ë‹ˆë‹¤. ë§ˆì¹˜ ì»´í“¨í„°ì˜ ë³€ìˆ˜ì²˜ëŸ¼ ìƒê°í•˜ì‹œë©´ ë©ë‹ˆë‹¤.',
        'TIMER': name + 'ì€ ì‹œê°„ì„ ì¬ëŠ” íƒ€ì´ë¨¸ì…ë‹ˆë‹¤. ì„¤ì •ëœ ì‹œê°„ì´ ì§€ë‚˜ë©´ ë™ì‘í•©ë‹ˆë‹¤.'
    };

    return explanations[type] || name + 'ì— ëŒ€í•œ ê¸°ë³¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
}

function getInstructionKoreanName(instruction) {
    const names = {
        'LD': 'ë¡œë“œ (ì ‘ì  ì½ê¸°)',
        'LDI': 'ë¡œë“œ ì¸ë²„ìŠ¤',
        'AND': 'ê·¸ë¦¬ê³  (ì§ë ¬)',
        'ANI': 'ê·¸ë¦¬ê³  ì¸ë²„ìŠ¤',
        'OR': 'ë˜ëŠ” (ë³‘ë ¬)',
        'OUT': 'ì¶œë ¥',
        'SET': 'ì…‹ (ë˜ì¹˜)',
        'RST': 'ë¦¬ì…‹ (í•´ì œ)'
    };

    return names[instruction] || instruction;
}

function getInstructionExplanation(instruction, device) {
    const explanations = {
        'LD': 'LD ëª…ë ¹ì–´ëŠ” ë˜ë”ì˜ ì‹œì‘ì ì…ë‹ˆë‹¤. ' + device + ' ì…ë ¥ì´ ONë˜ë©´ ì „ë¥˜ê°€ íë¦…ë‹ˆë‹¤.',
        'AND': 'AND ëª…ë ¹ì–´ëŠ” ì´ì „ ì¡°ê±´ê³¼ ' + device + ' ì¡°ê±´ì´ ëª¨ë‘ ì°¸ì¼ ë•Œë§Œ ì „ë¥˜ê°€ íë¦…ë‹ˆë‹¤.',
        'OUT': 'OUT ëª…ë ¹ì–´ëŠ” ì¡°ê±´ì´ ì°¸ì¼ ë•Œ ' + device + ' ì¶œë ¥ì„ ONì‹œí‚µë‹ˆë‹¤.',
        'RST': 'RST ëª…ë ¹ì–´ëŠ” ì¡°ê±´ì´ ì°¸ì¼ ë•Œ ' + device + 'ë¥¼ ê°•ì œë¡œ OFFì‹œí‚µë‹ˆë‹¤.'
    };

    return explanations[instruction] || instruction + ' ëª…ë ¹ì–´ê°€ ' + device + 'ì— ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.';
}
</script>
{% endblock %}